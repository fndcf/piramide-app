<div class="player-dashboard">
  <header class="dashboard-header">
    <div class="header-content">
      <h1>Dashboard Jogador</h1>
      <div class="header-actions">
        <span class="user-greeting">{{ (currentUser?.phone || '') | phone }}</span>
        <app-button variant="outline" size="small" (click)="logout()">
          Sair
        </app-button>
      </div>
    </div>
  </header>

  <main class="dashboard-main">
    <!-- ‚úÖ ALERTA DE DESAFIO ATIVO -->
    <div class="active-challenge-alert" *ngIf="hasActiveChallenge">
      <div class="alert-content">
        <div class="alert-icon">‚öîÔ∏è</div>
        <div class="alert-info">
          <h3>Voc√™ tem um desafio ativo!</h3>
          <p>
            <strong>{{ activeChallengeInfo.challengeType === 'as_challenger' ? 'Voc√™ desafiou' : 'Voc√™ foi desafiado por' }}:</strong>
            {{ activeChallengeInfo.opponentName }}
          </p>
          <p class="alert-status">
            <strong>Status:</strong> {{ getStatusDescription(activeChallengeInfo.challengeStatus) }}
          </p>
        </div>
        <div class="alert-actions">
          <app-button 
            variant="primary" 
            size="small"
            (click)="goToActiveChallenge()">
            Ver Desafio
          </app-button>
        </div>
      </div>
    </div>

    <!-- ‚úÖ NAVEGA√á√ÉO POR ABAS -->
    <div class="dashboard-tabs">
      <button 
        class="tab-button"
        [class.active]="selectedTab === 'ranking'"
        (click)="selectTab('ranking')">
        üèÜ Ranking
      </button>
      <button 
        class="tab-button"
        [class.active]="selectedTab === 'challenges'"
        (click)="selectTab('challenges')">
        ‚öîÔ∏è Desafios
        <span class="challenge-badge" *ngIf="hasActiveChallenge">‚óè</span>
      </button>
    </div>

    <!-- ‚úÖ ABA DO RANKING -->
    <div class="tab-content" *ngIf="selectedTab === 'ranking'">
      <!-- ‚úÖ INFORMA√á√ïES DA MINHA DUPLA COM ESTAT√çSTICAS -->
      <section class="my-couple-section" *ngIf="myCouple$ | async as myCouple">
        <div class="section-header">
          <h2>Minha Dupla</h2>
        </div>
        
        <div class="my-couple-card" [class.has-active-challenge]="hasActiveChallenge">
          <div class="couple-info">
            <h3>{{ myCouple.player1Name }} / {{ myCouple.player2Name }}</h3>
            
            <!-- ‚úÖ INDICADOR DE DESAFIO ATIVO -->
            <div class="active-challenge-indicator" *ngIf="hasActiveChallenge">
              <span class="indicator-icon">‚öîÔ∏è</span>
              <span class="indicator-text">Desafio ativo em andamento</span>
            </div>
            
            <!-- ‚úÖ ESTAT√çSTICAS PRINCIPAIS -->
            <div class="couple-stats">
              <div class="stat">
                <span class="stat-label">Posi√ß√£o Atual:</span>
                <span class="stat-value position">{{ myCouple.position }}¬∫ lugar</span>
              </div>
              <div class="stat">
                <span class="stat-label">Vit√≥rias/Derrotas:</span>
                <span class="stat-value record">{{ myCouple.stats.victories }}-{{ myCouple.stats.defeats }}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Taxa de Vit√≥ria:</span>
                <span class="stat-value winrate">{{ myCouple.stats.winRate }}%</span>
              </div>
            </div>

            <!-- ‚úÖ ESTAT√çSTICAS DETALHADAS -->
            <div class="detailed-stats">
              <div class="stats-row">
                <div class="mini-stat">
                  <span class="mini-value">{{ myCouple.stats.totalGames }}</span>
                  <span class="mini-label">Jogos</span>
                </div>
                <div class="mini-stat" [class.positive]="myCouple.stats.currentStreak > 0" 
                                      [class.negative]="myCouple.stats.currentStreak < 0">
                  <span class="mini-value">{{ getMathAbs(myCouple.stats.currentStreak) }}</span>
                  <span class="mini-label">{{ getStreakLabel(myCouple.stats.currentStreak) }}</span>
                </div>
                <div class="mini-stat">
                  <span class="mini-value">{{ myCouple.stats.bestStreak }}</span>
                  <span class="mini-label">Melhor</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ‚úÖ RANKING GERAL COM POSI√á√ïES E BOT√ïES -->
      <section class="ranking-section">
        <div class="section-header">
          <h2>Ranking Geral</h2>
          <p class="ranking-info">
            <span *ngIf="!hasActiveChallenge">Voc√™ pode desafiar duplas at√© 2 posi√ß√µes acima da sua</span>
            <span *ngIf="hasActiveChallenge" class="ranking-blocked">
              ‚ö†Ô∏è Finalize seu desafio ativo antes de criar um novo desafio
            </span>
          </p>
        </div>

        <div class="ranking-list" *ngIf="allCouples$ | async as allCouples; else loading">
          <div class="ranking-item" 
               *ngFor="let couple of allCouples; let i = index; trackBy: trackByCouple"
               [class.my-couple]="(myCouple$ | async) && couple.id === (myCouple$ | async)?.id"
               [class.challengeable]="(myCouple$ | async) && canChallenge((myCouple$ | async)!, couple)"
               [class.blocked-by-active-challenge]="hasActiveChallenge && couple.id !== (myCouple$ | async)?.id"
               [class.target-has-active-challenge]="targetHasActiveChallenge(couple.id!)"
               [class.podium]="i < 3">
            
            <!-- ‚úÖ BADGE DE POSI√á√ÉO COM CORES -->
            <div class="position-badge" [class]="getPositionBadgeClass(couple.position)">
              {{ couple.position }}¬∫
            </div>
            
            <!-- ‚úÖ DETALHES DA DUPLA COM ESTAT√çSTICAS -->
            <div class="couple-details">
              <h4>
                {{ couple.player1Name }} / {{ couple.player2Name }}
                <!-- ‚úÖ NOVO: Indicador de desafio ativo -->
                <span class="active-challenge-badge" *ngIf="targetHasActiveChallenge(couple.id!)">
                  ‚öîÔ∏è Em desafio
                </span>
              </h4>
              <div class="position-description">{{ getPositionDescription(couple.position) }}</div>
              
              <!-- ‚úÖ ESTAT√çSTICAS NO RANKING -->
              <div class="ranking-stats">
                <span class="stat-item">
                  <strong>{{ couple.stats.victories }}-{{ couple.stats.defeats }}</strong>
                  ({{ couple.stats.winRate }}%)
                </span>
                <span class="stat-separator">‚Ä¢</span>
                <span class="stat-item">{{ couple.stats.totalGames }} jogos</span>
                
                <span class="streak-indicator" *ngIf="couple.stats.currentStreak !== 0"
                      [class.hot-streak]="couple.stats.currentStreak >= 3"
                      [class.cold-streak]="couple.stats.currentStreak <= -3">
                  {{ getStreakDisplay(couple.stats.currentStreak) }}
                </span>
              </div>
            </div>

            <!-- ‚úÖ A√á√ïES DA DUPLA (BOT√ïES DE DESAFIO) -->
            <div class="couple-actions" *ngIf="myCouple$ | async as myCouple">
              <!-- ‚úÖ BOT√ÉO DESAFIAR (DESABILITADO SE TEM DESAFIO ATIVO) -->
              <app-button 
                *ngIf="canChallenge(myCouple, couple)"
                variant="primary" 
                size="small"
                [loading]="isLoading"
                [disabled]="hasActiveChallenge"
                (click)="challengeCouple(couple)">
                ‚öîÔ∏è Desafiar
              </app-button>
              
              <!-- ‚úÖ MOTIVO POR QUE N√ÉO PODE DESAFIAR -->
              <span *ngIf="!canChallenge(myCouple, couple) && couple.id !== myCouple.id" 
                    class="cannot-challenge"
                    [class.active-challenge-blocked]="hasActiveChallenge">
                {{ getCannotChallengeReason(myCouple, couple) }}
              </span>
              
              <!-- ‚úÖ INDICADOR DA SUA POSI√á√ÉO -->
              <span *ngIf="couple.id === myCouple.id" class="my-position">
                ‚ú® Sua posi√ß√£o atual
              </span>
            </div>
          </div>
        </div>

        <ng-template #loading>
          <div class="loading-state">
            <p>Carregando ranking...</p>
          </div>
        </ng-template>
      </section>
    </div>

    <!-- ‚úÖ ABA DOS DESAFIOS -->
    <div class="tab-content" *ngIf="selectedTab === 'challenges'">
      <section class="challenges-section">
        <div class="section-header">
          <h2>Meus Desafios</h2>
          <p class="section-description">
            Acompanhe seus desafios enviados e recebidos
          </p>
          
          <!-- ‚úÖ STATUS DO DESAFIO ATIVO -->
          <div class="active-challenge-summary" *ngIf="hasActiveChallenge">
            <div class="summary-content">
              <span class="summary-icon">‚öîÔ∏è</span>
              <div class="summary-text">
                <strong>Desafio Ativo:</strong>
                {{ activeChallengeInfo.challengeType === 'as_challenger' ? 'Voc√™ desafiou' : 'Voc√™ foi desafiado por' }}
                {{ activeChallengeInfo.opponentName }}
                <br>
                <small>{{ getStatusDescription(activeChallengeInfo.challengeStatus) }}</small>
              </div>
            </div>
          </div>
          
          <!-- ‚úÖ BOT√ÉO TEMPOR√ÅRIO PARA TESTAR HOR√ÅRIOS -->
          <div class="debug-actions" style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border-radius: 8px;">
            <p><strong>üß™ Teste:</strong> Use este bot√£o se o resultado n√£o apareceu na hora:</p>
            <app-button 
              variant="danger" 
              size="small"
              (click)="forceCheckGameTime()">
              üîÑ Verificar Hor√°rios Agora
            </app-button>
          </div>
        </div>

        <div class="challenges-list" *ngIf="challenges$ | async as challenges; else loadingChallenges">
          <!-- ‚úÖ LISTA DE DESAFIOS -->
          <div class="challenges-container" *ngIf="challenges.length > 0; else noChallenges">
            <app-challenge
              *ngFor="let challenge of challenges; trackBy: trackByChallenge"
              [id]="'challenge-' + challenge.id"
              [challenge]="challenge"
              [currentCoupleId]="(myCouple$ | async)?.id || ''"
              [isLoading]="isLoading"
              [class.active-challenge]="hasActiveChallenge && challenge.id === activeChallengeInfo.challengeId"
              (respondToChallenge)="onRespondToChallenge($event)"
              (proposeDates)="onProposeDates($event)"
              (selectDate)="onSelectDate($event)"
              (makeCounterProposal)="onMakeCounterProposal($event)"
              (respondToCounter)="onRespondToCounter($event)"
              (reportResult)="onReportResult($event)"
              (confirmResult)="onConfirmResult($event)">
            </app-challenge>
          </div>

          <!-- ‚úÖ ESTADO VAZIO -->
          <ng-template #noChallenges>
            <div class="empty-state">
              <div class="empty-icon">‚öîÔ∏è</div>
              <h3>Nenhum desafio ainda</h3>
              <p>
                Voc√™ ainda n√£o tem desafios enviados ou recebidos.
                <br>
                <span *ngIf="!hasActiveChallenge">V√° para o ranking e desafie outras duplas!</span>
                <span *ngIf="hasActiveChallenge">Voc√™ s√≥ pode ter um desafio ativo por vez.</span>
              </p>
              <app-button 
                *ngIf="!hasActiveChallenge"
                variant="primary"
                (click)="selectTab('ranking')">
                Ver Ranking
              </app-button>
            </div>
          </ng-template>
        </div>

        <ng-template #loadingChallenges>
          <div class="loading-state">
            <p>Carregando desafios...</p>
          </div>
        </ng-template>
      </section>
    </div>
  </main>
</div>